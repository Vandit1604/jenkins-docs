<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using Docker with Pipeline :: Jenkins</title>
    <link rel="canonical" href="https://docs.jenkins.com/solutions/2.401.3/docker.html">
    <link rel="prev" href="php.html">
    <link rel="next" href="python.html">
    <meta name="generator" content="Antora 3.1.5">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
<link rel="icon" href="../../_/jenkins.svg" type="image/x-icon">
  </head>
  <body class="article">
<script type="module" src="https://unpkg.com/@jenkinsci/jenkins-io-components?module"></script>
<jio-navbar style="  position: fixed;
  top: 0;
  width: 100vw;
  z-index: 100;"></jio-navbar>
  <div class="body">
<div class="nav-container" data-component="solutions" data-version="2.401.3">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Jenkins Solutions Page</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="android.html">Jenkins and Android</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="php.html">Jenkins and PHP</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="docker.html">Using Docker with Pipeline</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="python.html">"Jenkins and Python"</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ruby.html">Jenkins and Ruby</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pipeline.html">Pipeline as Code with Jenkins</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="github.html">Jenkins with GitHub</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="embedded.html">Jenkins in the Embedded World</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bitbucketserver.html">Bitbucket Server</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="c.html">Jenkins and C/C++</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../user-docs/2.401.3/platform-information/support-policy-java.html">Java Support Policy</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Jenkins Solutions Page</span>
    <span class="version">2.401.3</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../about/index.html">About Jenkins</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../about/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../images/index.html">All of Jenkins Images</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../images/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../books/index.html">Jenkins Books</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../books/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../community/index.html">Jenkins Community</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../community/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../dev-docs/index.html">Jenkins Developer Documentation</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../dev-docs/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../download/latest/index.html">Jenkins Download and Deployment</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../download/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../events/index.html">Jenkins Events</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../events/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../Jenkins%20Project/index.html">Jenkins Project</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../Jenkins%20Project/index.html">default</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../projects/index.html">Jenkins Projects</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../projects/index.html">default</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../security/index.html">Jenkins Security Advisories</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../security/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">Jenkins Solutions Page</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">2.401.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../sigs/index.html">Jenkins Special Interest Groups</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../sigs/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../tutorial/2.401.3/index.html">Jenkins Tutorials</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../tutorial/2.401.3/index.html">2.401.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../user-docs/2.401.3/index.html">Jenkins User Documentation</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../user-docs/2.401.3/index.html">2.401.3</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../user-docs/2.401.3/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Jenkins Solutions Page</a></li>
    <li><a href="docker.html">Using Docker with Pipeline</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/Vandit1604/jenkins-docs/edit/main/docs/solutions/modules/ROOT/pages/docker.adoc"><svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M441 58.9L453.1 71c9.4 9.4 9.4 24.6 0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9 0zM209.8 256.2L344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1l-58.5 16.7 16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25L175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 100c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l100-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7 0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4 0 152V424c0 48.6 39.4 88 88 88H360c48.6 0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1 0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H200c13.3 0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg>  Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Using Docker with Pipeline</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Many organizations use <a href="https://www.docker.com">Docker</a> to unify their build and test environments across machines, and to provide an efficient mechanism for deploying applications.
Starting with Pipeline versions 2.5 and higher, Pipeline has built-in support for interacting with Docker from within a <code>Jenkinsfile</code>.</p>
</div>
<div class="paragraph">
<p>While this page covers the basics of utilizing Docker from within a <code>Jenkinsfile</code>, it will not cover the fundamentals of Docker, which you can refer to in the <a href="https://docs.docker.com/get-started/">Docker Getting Started Guide</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="execution-environment"><a class="anchor" href="#execution-environment"></a>Customizing the execution environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pipeline is designed to easily use <a href="https://docs.docker.com/">Docker</a> images as the execution environment for a single <a href="../../user-docs/2.401.3/glossary/index.html#stage" class="xref page">Stage</a> or the entire Pipeline.
Meaning that a user can define the tools required for their Pipeline, without having to manually configure agents.
Any tool that can be <a href="https://hub.docker.com">packaged in a Docker container</a> can be used with ease, by making only minor edits to a <code>Jenkinsfile</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// Declarative //
pipeline {
    agent {
        docker { image 'node:20.9.0-alpine3.18' }
    }
    stages {
        stage('Test') {
            steps {
                sh 'node --version'
            }
        }
    }
}
// Script //
node {
    /* Requires the Docker Pipeline plugin to be installed */
    docker.image('node:20.9.0-alpine3.18').inside {
        stage('Test') {
            sh 'node --version'
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>When the Pipeline executes, Jenkins will automatically start the specified container and execute the defined steps within:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[Pipeline] stage
[Pipeline] { (Test)
[Pipeline] sh
[guided-tour] Running shell script
+ node --version
v16.13.1
[Pipeline] }
[Pipeline] // stage
[Pipeline] }</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_workspace_synchronization"><a class="anchor" href="#_workspace_synchronization"></a>Workspace synchronization</h3>
<div class="paragraph">
<p>If it is important to keep the workspace synchronized with other stages, use <code>reuseNode true</code>.
Otherwise, a dockerized stage can be run on the same agent or any other agent, but in a temporary workspace.</p>
</div>
<div class="paragraph">
<p>By default, for a containerized stage, Jenkins:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Picks an agent.</p>
</li>
<li>
<p>Creates a new empty workspace.</p>
</li>
<li>
<p>Clones pipeline code into it.</p>
</li>
<li>
<p>Mounts this new workspace into the container.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you have multiple Jenkins agents, your containerized stage can be started on any of them.</p>
</div>
<div class="paragraph">
<p>When <code>reuseNode</code> is set to <code>true</code>, no new workspace will be created, and the current workspace from the current agent will be mounted into the container.
After this, the container will be started on the same node, so all of the data will be synchronized.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// Declarative //
pipeline {
    agent any
    stages {
        stage('Build') {
            agent {
                docker {
                    image 'gradle:8.2.0-jdk17-alpine'
                    // Run the container on the node specified at the
                    // top-level of the Pipeline, in the same workspace,
                    // rather than on a new node entirely:
                    reuseNode true
                }
            }
            steps {
                sh 'gradle --version'
            }
        }
    }
}
// Script //
// Option "reuseNode true" currently unsupported in scripted pipeline</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_caching_data_for_containers"><a class="anchor" href="#_caching_data_for_containers"></a>Caching data for containers</h3>
<div class="paragraph">
<p>Many build tools will download external dependencies and cache them locally for future re-use.
Since containers are initially created with "clean" file systems, this can result in slower Pipelines, as they may not take advantage of on-disk caches between subsequent Pipeline runs.</p>
</div>
<div class="paragraph">
<p>Pipeline supports adding custom arguments that are passed to Docker, allowing users to specify custom <a href="https://docs.docker.com/engine/tutorials/dockervolumes/">Docker Volumes</a> to mount, which can be used for caching data on the <a href="../../user-docs/2.401.3/glossary/index.html#agent" class="xref page">agent</a> between Pipeline runs.
The following example will cache <code>~/.m2</code> between Pipeline runs utilizing the <a href="https://hub.docker.com/_/maven/"><code>maven</code> container</a>, avoiding the need to re-download dependencies for subsequent Pipeline runs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// Declarative //
pipeline {
    agent {
        docker {
            image 'maven:3.9.3-eclipse-temurin-17'
            args '-v $HOME/.m2:/root/.m2'
        }
    }
    stages {
        stage('Build') {
            steps {
                sh 'mvn -B'
            }
        }
    }
}
// Script //
node {
    /* Requires the Docker Pipeline plugin to be installed */
    docker.image('maven:3.9.5-eclipse-temurin-17-alpine').inside('-v $HOME/.m2:/root/.m2') {
        stage('Build') {
            sh 'mvn -B'
        }
    }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_multiple_containers"><a class="anchor" href="#_using_multiple_containers"></a>Using multiple containers</h3>
<div class="paragraph">
<p>It has become increasingly common for code bases to rely on multiple different technologies.
For example, a repository might have both a Java-based back-end API implementation <em>and</em> a JavaScript-based front-end implementation.
Combining Docker and Pipeline allows a <code>Jenkinsfile</code> to use <strong>multiple</strong> types of technologies, by combining the <code>agent {}</code> directive with different stages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// Declarative //
pipeline {
    agent none
    stages {
        stage('Back-end') {
            agent {
                docker { image 'maven:3.9.5-eclipse-temurin-17-alpine' }
            }
            steps {
                sh 'mvn --version'
            }
        }
        stage('Front-end') {
            agent {
                docker { image 'node:20.9.0-alpine3.18' }
            }
            steps {
                sh 'node --version'
            }
        }
    }
}
// Script //
node {
    /* Requires the Docker Pipeline plugin to be installed */

    stage('Back-end') {
        docker.image('maven:3.9.5-eclipse-temurin-17-alpine').inside {
            sh 'mvn --version'
        }
    }

    stage('Front-end') {
        docker.image('node:20.9.0-alpine3.18').inside {
            sh 'node --version'
        }
    }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dockerfile"><a class="anchor" href="#dockerfile"></a>Using a Dockerfile</h3>
<div class="paragraph">
<p>For projects requiring a more customized execution environment, Pipeline also supports building and running a container from a <code>Dockerfile</code> in the source repository.
In contrast to the <a href="#execution-environment">previous approach</a> of using an "off-the-shelf" container, using the <code>agent { dockerfile true }</code> syntax builds a new image from a <code>Dockerfile</code>, rather than pulling one from <a href="https://hub.docker.com">Docker Hub</a>.</p>
</div>
<div class="paragraph">
<p>Reusing an example from above, with a more custom <code>Dockerfile</code>:</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">FROM node:20.9.0-alpine3.18

RUN apk add -U subversion</code></pre>
</div>
</div>
<div class="paragraph">
<p>By committing this to the root of the source repository, the <code>Jenkinsfile</code> can be changed to build a container based on this <code>Dockerfile</code>, and then run the defined steps using that container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// Declarative //
pipeline {
    agent { dockerfile true }
    stages {
        stage('Test') {
            steps {
                sh 'node --version'
                sh 'svn --version'
            }
        }
    }
}
// Script //</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>agent { dockerfile true }</code> syntax supports a number of other options, which are described in more detail in the <a href="../../user-docs/2.401.3/pipeline/syntax.html#agent" class="xref page">Pipeline Syntax</a> section.</p>
</div>
<div class="videoblock">
<div class="title">Using a Dockerfile with Jenkins Pipeline</div>
<div class="content">
<iframe width="852" height="480" src="https://www.youtube.com/embed/Pi2kJ2RJS50?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_specifying_a_docker_label"><a class="anchor" href="#_specifying_a_docker_label"></a>Specifying a Docker Label</h3>
<div class="paragraph">
<p>By default, Pipeline assumes that <em>any</em> configured <a href="../../user-docs/2.401.3/glossary/index.html#agent" class="xref page">agent</a> is capable of running Docker-based Pipelines.
For Jenkins environments that have macOS, Windows, or other agents that are unable to run the Docker daemon, this default setting may be problematic.
Pipeline provides a global option on the <strong>Manage Jenkins</strong> page and on the <a href="../../user-docs/2.401.3/glossary/index.html#folder" class="xref page">Folder</a> level, for specifying which agents (by <a href="../../user-docs/2.401.3/glossary/index.html#label" class="xref page">Label</a>) to use for running Docker-based Pipelines.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="pipeline/configure-docker-label.png" alt="Configuring the Pipeline Docker Label">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_path_setup_for_mac_os_users"><a class="anchor" href="#_path_setup_for_mac_os_users"></a>Path setup for mac OS users</h3>
<div class="paragraph">
<p>The <code>/usr/local/bin</code> directory is not included in the macOS <code>PATH</code> for Docker images by default.
If executables from <code>/usr/local/bin</code> need to be called from within Jenkins, the <code>PATH</code> needs to be extended to include <code>/usr/local/bin</code>.
Add a path node in the file "/usr/local/Cellar/jenkins-lts/XXX/homebrew.mxcl.jenkins-lts.plist" like this:</p>
</div>
<div class="listingblock">
<div class="title">Contents of homebrew.mxcl.jenkins-lts.plist</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;key&gt;EnvironmentVariables&lt;/key&gt;
&lt;dict&gt;
&lt;key&gt;PATH&lt;/key&gt;
&lt;string&gt;&lt;!-- insert revised path here --&gt;&lt;/string&gt;
&lt;/dict&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The revised <code>PATH</code> <code>string</code> should be a colon separated list of directories in the same format as the <code>PATH</code> environment variable and should include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/usr/local/bin</code></p>
</li>
<li>
<p><code>/usr/bin</code></p>
</li>
<li>
<p><code>/bin</code></p>
</li>
<li>
<p><code>/usr/sbin</code></p>
</li>
<li>
<p><code>/sbin</code></p>
</li>
<li>
<p><code>/Applications/Docker.app/Contents/Resources/bin/</code></p>
</li>
<li>
<p><code>/Users/XXX/Library/Group\ Containers/group.com.docker/Applications/Docker.app/Contents/Resources/bin</code> (where <code>XXX</code> is replaced by your user name)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now, restart jenkins using <code>brew services restart jenkins-lts</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_usage_with_scripted_pipeline"><a class="anchor" href="#_advanced_usage_with_scripted_pipeline"></a>Advanced Usage with Scripted Pipeline</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_running_sidecar_containers"><a class="anchor" href="#_running_sidecar_containers"></a>Running "sidecar" containers</h3>
<div class="paragraph">
<p>Using Docker in Pipeline is an effective way to run a service on which the build, or a set of tests, may rely.
Similar to the <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar">sidecar pattern</a>, Docker Pipeline can run one container "in the background", while performing work in another.
Utilizing this sidecar approach, a Pipeline can have a "clean" container provisioned for each Pipeline run.</p>
</div>
<div class="paragraph">
<p>Consider a hypothetical integration test suite that relies on a local MySQL database to be running.
Using the <code>withRun</code> method, implemented in the plugin:docker-workflow[Docker Pipeline] plugin&#8217;s support for Scripted Pipeline, a <code>Jenkinsfile</code> can run MySQL as a sidecar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm
    /*
     * In order to communicate with the MySQL server, this Pipeline explicitly
     * maps the port (`3306`) to a known port on the host machine.
     */
    docker.image('mysql:8-oracle').withRun('-e "MYSQL_ROOT_PASSWORD=my-secret-pw"' +
                                           ' -p 3306:3306') { c -&gt;
        /* Wait until mysql service is up */
        sh 'while ! mysqladmin ping -h0.0.0.0 --silent; do sleep 1; done'
        /* Run some tests which require MySQL */
        sh 'make check'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example can be taken further, utilizing two containers simultaneously.
One "sidecar" running MySQL, and another providing the <a href="#execution-environment">execution environment</a> by using the Docker <a href="https://docs.docker.com/engine/userguide/networking/default_network/dockerlinks/">container links</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm
    docker.image('mysql:8-oracle').withRun('-e "MYSQL_ROOT_PASSWORD=my-secret-pw"') { c -&gt;
        docker.image('mysql:8-oracle').inside("--link ${c.id}:db") {
            /* Wait until mysql service is up */
            sh 'while ! mysqladmin ping -hdb --silent; do sleep 1; done'
        }
        docker.image('oraclelinux:9').inside("--link ${c.id}:db") {
            /*
             * Run some tests that require MySQL, and assume that it is
             * available on the host name `db`
             */
            sh 'make check'
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example uses the object exposed by <code>withRun</code>, which has the running container&#8217;s ID available via the <code>id</code> property.
Using the container&#8217;s ID, the Pipeline can create a link by passing custom Docker arguments to the <code>inside()</code> method.</p>
</div>
<div class="paragraph">
<p>The <code>id</code> property can also be useful for inspecting logs from a running Docker container before the Pipeline exits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">sh "docker logs ${c.id}"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_containers"><a class="anchor" href="#_building_containers"></a>Building containers</h3>
<div class="paragraph">
<p>In order to create a Docker image, the plugin:docker-workflow[Docker Pipeline] plugin also provides a <code>build()</code> method for creating a new image from a <code>Dockerfile</code> in the repository during a Pipeline run.</p>
</div>
<div class="paragraph">
<p>One major benefit of using the syntax <code>docker.build("my-image-name")</code> is that a Scripted Pipeline can use the return value for subsequent Docker Pipeline calls, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm

    def customImage = docker.build("my-image:${env.BUILD_ID}")

    customImage.inside {
        sh 'make test'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The return value can also be used to publish the Docker image to <a href="https://hub.docker.com">Docker Hub</a> or a <a href="#custom-registry">custom Registry</a>, via the <code>push()</code> method, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm
    def customImage = docker.build("my-image:${env.BUILD_ID}")
    customImage.push()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One common usage of image "tags" is to specify a <code>latest</code> tag for the most recently validated version of a Docker image.
The <code>push()</code> method accepts an optional <code>tag</code> parameter, allowing the Pipeline to push the <code>customImage</code> with different tags, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm
    def customImage = docker.build("my-image:${env.BUILD_ID}")
    customImage.push()

    customImage.push('latest')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>build()</code> method builds the <code>Dockerfile</code> in the current directory by default.
This can be overridden by providing a directory path containing a <code>Dockerfile</code> as the second argument of the <code>build()</code> method, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm
    def testImage = docker.build("test-image", "./dockerfiles/test") <i class="conum" data-value="1"></i><b>(1)</b>

    testImage.inside {
        sh 'make test'
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Builds <code>test-image</code> from the Dockerfile found at <code>./dockerfiles/test/Dockerfile</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to pass other arguments to <a href="https://docs.docker.com/engine/reference/commandline/build/"><code>docker build</code></a> by adding them to the second argument of the <code>build()</code> method.
When passing arguments this way, the last value in the string must be the path to the docker file, and should end with the folder to use as the build context.</p>
</div>
<div class="paragraph">
<p>This example overrides the default <code>Dockerfile</code> by passing the <code>-f</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm
    def dockerfile = 'Dockerfile.test'
    def customImage = docker.build("my-image:${env.BUILD_ID}",
                                   "-f ${dockerfile} ./dockerfiles") <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Builds <code>my-image:${env.BUILD_ID}</code> from the Dockerfile found at <code>./dockerfiles/Dockerfile.test</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_remote_docker_server"><a class="anchor" href="#_using_a_remote_docker_server"></a>Using a remote Docker server</h3>
<div class="paragraph">
<p>By default, the plugin:docker-workflow[Docker Pipeline] plugin will communicate with a local Docker daemon, typically accessed through <code>/var/run/docker.sock</code>.</p>
</div>
<div class="paragraph">
<p>To select a non-default Docker server, such as with <a href="https://docs.docker.com/swarm/">Docker Swarm</a>, use the <code>withServer()</code> method.</p>
</div>
<div class="paragraph">
<p>You can pass a URI, and optionally the Credentials ID of a <strong>Docker Server Certificate Authentication</strong> pre-configured in Jenkins, to the method with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm

    docker.withServer('tcp://swarm.example.com:2376', 'swarm-certs') {
        docker.image('mysql:8-oracle').withRun('-p 3306:3306') {
            /* do things */
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>inside()</code> and <code>build()</code> will not work properly with a Docker Swarm server out of the box.</p>
</div>
<div class="paragraph">
<p>For <code>inside()</code> to work, the Docker server and the Jenkins agent must use the same filesystem, so that the workspace can be mounted.</p>
</div>
<div class="paragraph">
<p>Currently, neither the Jenkins plugin nor the Docker CLI will automatically detect the case that the server is running remotely.
A typical symptom of this would be errors from nested <code>sh</code> commands such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cannot create /…@tmp/durable-…/pid: Directory nonexistent</code></pre>
</div>
</div>
<div class="paragraph">
<p>When Jenkins detects that the agent is itself running inside a Docker container, it will automatically pass the <code>--volumes-from</code> argument to the <code>inside</code> container, ensuring that it can share a workspace with the agent.</p>
</div>
<div class="paragraph">
<p>Additionally, some versions of Docker Swarm do not support custom Registries.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="custom-registry"><a class="anchor" href="#custom-registry"></a>Using a custom registry</h3>
<div class="paragraph">
<p>By default, the plugin:docker-workflow[Docker Pipeline] plugin assumes the default Docker Registry of <a href="https://hub.docker.com">Docker Hub</a>.</p>
</div>
<div class="paragraph">
<p>In order to use a custom Docker Registry, users of Scripted Pipeline can wrap steps with the <code>withRegistry()</code> method, passing in the custom Registry URL, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm

    docker.withRegistry('https://registry.example.com') {

        docker.image('my-custom-image').inside {
            sh 'make test'
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a Docker Registry requiring authentication, add a "Username/Password" Credentials item from the Jenkins home page and use the Credentials ID as a second argument to <code>withRegistry()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    checkout scm

    docker.withRegistry('https://registry.example.com', 'credentials-id') {

        def customImage = docker.build("my-image:${env.BUILD_ID}")

        /* Push the container to the custom Registry */
        customImage.push()
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="php.html">Jenkins and PHP</a></span>
  <span class="next"><a href="python.html">"Jenkins and Python"</a></span>
</nav>
</article>
  </div>
</main>
</div>
<jio-footer></jio-footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
